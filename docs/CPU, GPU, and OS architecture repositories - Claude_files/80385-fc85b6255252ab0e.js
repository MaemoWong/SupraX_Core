try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="0d6d7197-4847-400a-9081-15590a1aa628",e._sentryDebugIdIdentifier="sentry-dbid-0d6d7197-4847-400a-9081-15590a1aa628")}catch(e){}{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{};e._sentryModuleMetadata=e._sentryModuleMetadata||{},e._sentryModuleMetadata[new e.Error().stack]=Object.assign({},e._sentryModuleMetadata[new e.Error().stack],{"_sentryBundlerPluginAppKey:anthropic-apps":!0})}"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[80385],{0x12bfc937:(e,t,a)=>{a.d(t,{G:()=>y,S:()=>b});var n=a(0x164c6313f),r=a(0x20805e624),i=a(0x2349cee20),s=a(0xe670e093),l=a(0xfc89b4a4),o=a(0xe48b09ae),u=a(0x14de19ae8),d=a(0x2004f6966),c=a(0x1016c6ed2),m=a(0x9845e38c),f=a(0x16a879d4a),p=a(0x17e7bc007);function g(e){let t={};for(let[a,n]of Object.entries(e))void 0!==n&&(null===n||"object"!=typeof n?t[a]=n:Array.isArray(n)?t[a]=n.map(e=>"object"!=typeof e||null===e||Array.isArray(e)?e:g(e)):t[a]=g(n));return t}function v(e){return"integration_name"in e&&e.integration_name?(0,f.v)(d.WK,{toolVariant:{case:"frontendRemoteMcpTool",value:(0,f.v)(d.Ky,{name:e.name,description:e.description,inputSchema:g(e.input_schema),namespacedName:"",mcpServerUuid:"mcp_server_uuid"in e?e.mcp_server_uuid:void 0,integrationName:e.integration_name,integrationIconUrl:"integration_icon_url"in e?e.integration_icon_url:void 0,needsApproval:"needs_approval"in e?e.needs_approval:void 0,backendExecution:"backend_execution"in e?e.backend_execution:void 0})}}):"type"in e&&!("input_schema"in e)?(0,f.v)(d.WK,{toolVariant:{case:"anthropicTool",value:(0,f.v)(d.a3,{type:e.type,name:e.name})}}):"input_schema"in e&&"description"in e?(0,f.v)(d.WK,{toolVariant:{case:"claudeAiTool",value:(0,f.v)(d.aA,{name:e.name,description:e.description,inputSchema:g(e.input_schema)})}}):(0,f.v)(d.WK,{toolVariant:{case:"anthropicTool",value:(0,f.v)(d.a3,{type:"name"in e&&e.name?e.name:"unknown",name:e.name})}})}var x=a(0x20885504e);let _=e=>{};function h(e){var t;let a=(0,x.N)(),r=(0,l.useCallback)(t=>(p.oz.getState().pathUuidsByConversation[e.conversationUuid]||[]).includes(t),[e.conversationUuid]),i=(0,l.useCallback)(t=>{let a=p.oz.getState().pathUuidsByConversation[e.conversationUuid]||[],n=a.indexOf(t);return n>=0&&n<a.length-1?a[n+1]:null},[e.conversationUuid]),s=(0,l.useRef)(_),g=(0,p.Q3)(e.conversationUuid),{hasActiveStream:h}=((e,t,a,r)=>{let i=(()=>{let{activeOrganization:e}=(0,u.YL)();if(!e)throw Error("No active organization");return(0,l.useMemo)(()=>(0,n.wV)(e.uuid),[e.uuid])})(),[s,o]=(0,l.useState)(!1),[p,g]=(0,l.useState)(!1),[v,x]=(0,l.useState)(null),_=(0,l.useRef)(null),h=(0,l.useRef)(r);return(0,l.useEffect)(()=>{h.current=r},[r]),(0,l.useEffect)(()=>{if(a)return _.current=new AbortController,(async()=>{try{var a;x(null);let n=i.streamPendingCompletion((0,f.v)(d.mM,{chatConversationUuid:e,parentHumanMessageUuid:t||""}),{signal:null==(a=_.current)?void 0:a.signal});for await(let e of(o(!0),g(!0),n))if("completionEventJson"===e.payload.case)try{let t=JSON.parse(e.payload.value);h.current(t)}catch(e){m.v.error(m.u.CHAT_COMPLETION,"Failed to parse completion event",e)}else if("completionEventError"===e.payload.case){let t=e.payload.value,a={};try{a=JSON.parse(t.errorJson)}catch(e){m.v.error(m.u.CHAT_COMPLETION,"Failed to parse error_json from gRPC error response",e)}throw(0,c.a5)({status:t.statusCode,response:a,fallbackMessage:"HTTP error from private API",headers:void 0,endpoint:"/v1/mobile/streamPendingCompletion",method:"gRPC"})}}catch(e){"not_found"===e.code?g(!1):"AbortError"!==e.name&&(x(e),m.v.error(m.u.CHAT_COMPLETION,"Stream pending completion error",e))}finally{o(!1)}})(),()=>{var e;null==(e=_.current)||e.abort()}},[e,t,i,a]),{isConnected:s,hasActiveStream:p,error:v}})(e.conversationUuid,null==g?void 0:g.uuid,a&&!!e.pendingUserMessage,s.current),y=(0,o.S)({...e,enableCaching:a,...a&&{hasActiveStream:h,checkMessageExists:r,getAssistantMessageUuid:i}});s.current=y.handleEvent;let b=(0,l.useCallback)(async t=>{if(a){let a=e.getTools().map(v);return y.runStream({...t,enableCaching:!0,grpcTools:a})}return y.runStream(t)},[a,e,y]);return{...y,runStream:b,isCachedStreaming:a,isReconnected:null!=(t=y.isReconnected)&&t}}function y(e,t,a,o,u,d,c){let{onIncrementalCompletion:m,onStartAppend:f,onStreamCompleted:p}=(0,i.G)(o,u),g=h({conversationUuid:e,projectUuid:t,endpoint:n.ep.APPEND_MESSAGE_WITH_COMPLETION,onIncrementalCompletion:m,onStreamCompleted:p,getTools:a,onRetry:d,pendingUserMessage:c,onStartAppend:f}),{runStream:v}=g,x=(0,l.useCallback)(async t=>{let{prompt:a,attachments:n,files:i,syncSources:l,rethrowErrors:o=!1,modelOverride:u,parent_message_uuid:d,personalized_style:c,compass_mode:m,skipOptimisticUpdateOnStreamComplete:p=!1}=t,g="".concat(r.EL,"-").concat((0,s.b)()),x="".concat(r.B6,"-").concat((0,s.b)());await f(e,e=>{if(!e)throw Error("Conversation tree must be provided for tree append");let t=(0,r.ZQ)(e),s=[{uuid:g,content:[{type:"text",text:a,citations:[]}],created_at:new Date().toISOString(),sender:"human",attachments:n,files:i,files_v2:i,sync_sources:l,index:t+1,parent_message_uuid:null!=d?d:r.gF},{uuid:x,content:[],created_at:new Date().toISOString(),sender:"assistant",attachments:[],files:[],files_v2:[],sync_sources:[],index:t+2,parent_message_uuid:g,metadata:{compass_mode:m}}];return(0,r.xQ)(e,s)}),await v({prompt:a,attachments:n,files:i,syncSources:l,rethrowErrors:o,modelOverride:u,parent_message_uuid:d,personalized_style:c,compass_mode:null!=m?m:void 0,skipOptimisticUpdateOnStreamComplete:p})},[v,f,e]);return{...g,runStream:x}}function b(e,t,a,o,u,d,c,m){let{onIncrementalCompletion:f,onStreamCompleted:p,onStartAppend:g}=(0,i.G)(u,d),v=h({conversationUuid:e,projectUuid:t,endpoint:n.ep.RETRY_MESSAGE_WITH_COMPLETION,onIncrementalCompletion:f,onStreamCompleted:p,getTools:a,onRetry:c,pendingUserMessage:m,onStartAppend:g}),{runStream:x}=v,_=(0,l.useCallback)(async(t,a,n,i)=>{let l="".concat(r.B6,"-").concat((0,s.b)());await g(e,e=>{let a=[{uuid:l,content:[],created_at:new Date().toISOString(),sender:"assistant",attachments:[],files:[],files_v2:[],sync_sources:[],parent_message_uuid:t,selectedOption:0,index:(0,r.ZQ)(e)+1}];return(0,r.xQ)(e,a)}),await x({prompt:"",attachments:[],files:[],syncSources:[],parent_message_uuid:t,personalized_style:o,paprika_mode:null!=a?a:void 0,compass_mode:null!=n?n:void 0,isRetry:!0,modelOverride:i})},[e,x,g,o]);return{...v,runStream:_}}},0x26cff63b:(e,t,a)=>{a.d(t,{y:()=>o});var n=a(0x628a9a0b),r=a(0x14de19ae8),i=a(0x1de4b2c21);function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;if(e.length<=t)return e;let a=Math.ceil(t/2);return"".concat(e.substring(0,a),"\n\n  [...]\n\n  ").concat(e.substring(e.length-a))}var l=a(0xfc89b4a4);function o(e,t,a){let[o,u]=(0,l.useState)(!1),{activeOrganization:d}=(0,r.YL)(),c=!!e,m=null==e?void 0:e.name,f=(null==t?void 0:t.length)||0,p=(0,l.useMemo)(()=>{let e=null==t?void 0:t[0];return e?(0,i.C)(e):""},[t]),g=(0,l.useMemo)(()=>{if(p)return p;let e=(null==t?void 0:t[1])?(0,i.C)(t[1]):"";return e&&!a?["Message 1:",s(p),"Message 2:",s(e)].join("\n\n"):""},[t,a,p]),v=(null==e?void 0:e.uuid)||"",{mutate:x}=(0,n.HI)(v),{mutate:_,error:h}=(0,n.OZ)(v),y=(0,l.useRef)(!1);(0,l.useEffect)(()=>{if(c&&h&&!m&&p){if(y.current)return;let e=p.slice(0,30),t=p.length>30?"...":"";y.current=!0,x({name:"".concat(e).concat(t)})}},[c,h,m,g,x,p]),(0,l.useEffect)(()=>{c&&d&&!o&&!m&&0!==f&&g&&(u(!0),_({message_content:g,recent_titles:[]}))},[c,d,m,_,o,f,g])}},0x3b58c804:(e,t,a)=>{a.d(t,{F:()=>u});var n=a(0xf32c56dd),r=a(0x14de19ae8),i=a(0xac309a83),s=a(0xfc89b4a4),l=a(0x23e1b1f63);let o="payment-verification-reminder-dismissed";function u(){let{activeOrganization:e}=(0,r.YL)(),t=(0,n.st)(),[a,u]=(0,s.useState)(!1),d=(0,i.fS)("show_3ds_modal"),{data:c}=(0,l.PI)(d);return(0,s.useEffect)(()=>{var a;let n=localStorage.getItem(o);if(n){let e=new Date(n).getTime();if(new Date().getTime()-e<864e5)return void u(!1)}let r=d&&null!=(a=null==c?void 0:c.requires_3ds_verification)&&a;u(r),r&&t.track({event_key:"payment_modal_open",organization_id:null==e?void 0:e.uuid,modal_type:"3ds_verification_required"})},[d,c,t,e]),{shouldShowModal:a,dismissReminder:(0,s.useCallback)(()=>{let a=new Date().toISOString();localStorage.setItem(o,a),u(!1),t.track({event_key:"payment_modal_open",organization_id:null==e?void 0:e.uuid,action:"3ds_verification_dismissed",dismissed_at:a})},[t,e])}}},0x90b81730:(e,t,a)=>{a.d(t,{V:()=>s});var n=a(0xfc89b4a4),r=a(0x1fc7d761),i=a(0x17e7bc007);function s(e,t,a){let s=(0,i.Gu)(),{clearAllFeatures:l}=(0,r.Bk)();(0,n.useLayoutEffect)(()=>(a||s(e,t),()=>{l()}),[e,t,a,s,l])}},0x1df3358a6:(e,t,a)=>{a.r(t),a.d(t,{PaymentVerificationModal:()=>v});var n=a(0x22102fd88),r=a(0xf32c56dd),i=a(0xa5acf583),s=a(0x14de19ae8),l=a(0x139b5e710),o=a(0x1bdad8807),u=a(0x17185943),d=a(0x183548b63),c=a(0x17e725145),m=a(0xfc89b4a4),f=a(0x38e6572),p=a(0x23e1b1f63),g=a(0x3b58c804);function v(){let[e,t]=(0,m.useState)(!1),a=(0,r.st)(),{activeOrganization:v}=(0,s.YL)(),{addError:x,addSuccess:_}=(0,l.Y)(),h=(0,i._r)(),y=(0,c.useQueryClient)(),{shouldShowModal:b,dismissReminder:S}=(0,g.F)(),C=(0,p.Si)({onSuccess:async e=>{try{var r,i;let t=await (0,o.nW)(e.entity,h);if(!t)throw Error("Stripe failed to initialize");let s=await t.retrieveSetupIntent(e.clientSecret);if(s.error)throw Error(s.error.message);if((null==(r=s.setupIntent)?void 0:r.status)==="requires_action"){let a=await t.handleNextAction({clientSecret:e.clientSecret});if(a.error)throw Error(a.error.message)}else(null==(i=s.setupIntent)?void 0:i.status)==="succeeded"&&a.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_success_frictionless"});await y.invalidateQueries({queryKey:["check-3ds-required",null==v?void 0:v.uuid]}),a.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_success"}),_((0,n.jsx)(f.A,{defaultMessage:"Payment method verified",id:"OxNDDqJUSV"})),a.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_success"})}catch(e){x(e instanceof Error?"PAYMENT_VERIFICATION_FAILED"===e.message?(0,n.jsx)(f.A,{defaultMessage:"Payment verification failed",id:"9RpX03Q2ky"}):e.message.includes("Failed to redirect to https://hooks.stripe.com")||e.message.includes("3d_secure")||e.message.includes("hooks.stripe.com")?(0,n.jsx)(f.A,{defaultMessage:"Unable to complete payment verification. Check if pop-ups are blocked or try a different browser.",id:"sDFdJ5I8X1"}):e.message:(0,n.jsx)(f.A,{defaultMessage:"Payment verification failed. Please try again.",id:"0kXa3Rf5bZ"}),{error:e,errorContext:{tags:{source:"payment_verification"}}}),a.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_error",error_message:e instanceof Error?e.message:"Unknown error"})}finally{t(!1)}},onError:e=>{t(!1),x((0,n.jsx)(f.A,{defaultMessage:"Failed to start verification process. Please try again.",id:"3dT/r8rV5S"}),{error:e}),a.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_api_error",error_message:e.message})}}),w=()=>{S()};return b?(0,n.jsx)(d.aF,{isOpen:b,onClose:w,modalSize:"md",hasCloseButton:!0,title:(0,n.jsx)("div",{className:"flex items-center gap-2",children:(0,n.jsx)(u.E,{color:"secondary",size:"lg",children:(0,n.jsx)(f.A,{defaultMessage:"Action Required",id:"jWgFDt2Ifa"})})}),children:(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("h2",{className:"text-3xl font-medium text-text-100 mb-3",children:(0,n.jsx)(f.A,{defaultMessage:"Verify your payment method",id:"epYApo9bIj"})}),(0,n.jsx)("p",{className:"text-text-200 mb-6",children:(0,n.jsx)(f.A,{defaultMessage:"To comply with European security regulations, we need to verify your payment method using a quick one-time security process. This ensures your subscription remains active and secure.",id:"K0hDpiUx0B"})}),(0,n.jsxs)("div",{className:"flex flex-col gap-2 mt-6",children:[(0,n.jsx)(d.yl,{onClick:()=>{t(!0),a.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_start"});let e=window.location.href;C.mutate({return_url:e})},loading:e,className:"w-full",children:(0,n.jsx)(f.A,{defaultMessage:"Verify now",id:"t28SE7zKVA"})}),(0,n.jsx)(d.yl,{variant:"secondary",onClick:w,className:"w-full",children:(0,n.jsx)(f.A,{defaultMessage:"Remind me later",id:"c4hRLOnYpQ"})})]})]})}):null}},0x1e6343e61:(e,t,a)=>{a.d(t,{J:()=>H});var n=a(0x22102fd88),r=a(0x628a9a0b),i=a(0xb844abc8),s=a(0xec9172c1),l=a(0x16801a2b9),o=a(0x26cff63b),u=a(0x226530adf),d=a(0x2349cee20),c=a(0xf32c56dd),m=a(0x371cc700),f=a(0x1de4b2c21),p=a(0x4d348f95),g=a(0xfc89b4a4),v=a(0x18bfd014),x=a(0x225bae024),_=a(0x183548b63),h=a(0x1ab0d1ca1),y=a(0x38e6572),b=a(0x2662014e),S=a(0xf8bd7957),C=a(0x6fe0a7f6),w=a(0xb323e954),k=a(0x4c3e727b),M=a(0x84f104f3),j=a(0x16ba367e),E=a(0x1a1f6dda6);function N(e){let{fieldName:t,fieldSchema:a,isRequired:r,initialValue:i,hasSubmitError:s,clearSubmitError:l}=e,o=(0,h.A)(),[u,d]=(0,g.useState)(i),[c,m]=(0,g.useState)(s?R(u,a,r,o):null),f=(0,g.useCallback)(()=>{m(null),null==l||l(t)},[l,t]),p=(0,g.useCallback)(()=>{m(R(u,a,r,o))},[u,a,r,o]),v=a.type,x=a.title||a.description||t.charAt(0).toUpperCase()+t.slice(1),_=a.title&&a.description,y=(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{children:x}),r&&(0,n.jsx)("span",{className:"text-danger-000",children:"*"})]}),b=e=>(0,n.jsxs)("div",{className:"flex flex-col",children:[(0,n.jsx)(k.J,{label:y,className:"font-medium"}),_&&(0,n.jsx)("p",{className:"text-xs text-text-300 mb-1",children:a.description}),e,c&&(0,n.jsx)("p",{className:"text-xs text-danger-000 mt-1",children:c})]});switch(v){case"boolean":return(0,n.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,n.jsx)("input",{type:"hidden",name:t,value:u?"true":""}),(0,n.jsx)(w.S,{label:y,checked:!!u,onChange:e=>d(e),onFocus:f,onBlur:p,size:16,className:c?"border-danger-000":""}),_&&(0,n.jsx)("p",{className:"text-xs text-text-300 ml-[28px]",children:a.description}),c&&(0,n.jsx)("p",{className:"text-xs text-danger-000 ml-[28px]",children:c})]});case"number":return b((0,n.jsx)(C.ks,{name:t,type:"number",value:String(null!=u?u:""),onValueChange:e=>{if(!e)return void d("");let t=Number(e);isNaN(t)||d(t)},onFocus:f,onBlur:p,error:!!c,size:"lg",min:a.minimum,max:a.maximum,step:"any"}));case"integer":return b((0,n.jsx)(C.ks,{name:t,type:"number",value:String(null!=u?u:""),onValueChange:e=>{if(!e)return void d("");let t=Number(e);!isNaN(t)&&Number.isInteger(t)&&d(t)},onKeyDown:e=>{("."===e.key||"e"===e.key||"E"===e.key)&&e.preventDefault()},onFocus:f,onBlur:p,error:!!c,size:"lg",min:a.minimum,max:a.maximum,step:1}));case"string":{if(a.enum){let e=a.enum,r=a.enumNames;return b((0,n.jsxs)(M.l,{name:t,value:String(null!=u?u:""),onChange:e=>d(e.target.value),onFocus:f,onBlur:p,variant:c?"danger":"outline",size:"lg",children:[(0,n.jsx)("option",{value:""}),e.map((e,t)=>(0,n.jsx)("option",{value:String(e),children:(null==r?void 0:r[t])||String(e)},t))]}))}let e=a.minLength,r=a.maxLength,s=a.format;if(!s)return b((0,n.jsx)(C.fs,{name:t,value:String(null!=u?u:""),onChange:e=>d(e.target.value),onFocus:f,onBlur:p,minRows:String(null!=i?i:"").split("\n").length,className:c?"border-danger-000":"",minLength:e,maxLength:r}));return b((0,n.jsx)("input",{name:t,type:s,value:String(null!=u?u:""),onChange:e=>d(e.target.value),onFocus:f,onBlur:p,className:(0,E.A)((0,j.j)({size:"lg",error:!!c})),minLength:e,maxLength:r}))}default:return null}}function R(e,t,a,n){if(a){if("boolean"===t.type){if(!0!==e)return n.formatMessage({defaultMessage:"This field must be checked.",id:"J5kfUK4Fet"})}else if(null==e||""===e||"string"==typeof e&&!e.trim())return n.formatMessage({defaultMessage:"This field is required.",id:"6B5JtuWEoY"})}if(null==e||""===e)return null;if("string"===t.type){let a=String(e);if("minLength"in t){let e=t.minLength;if(a.length<e)return n.formatMessage({defaultMessage:"Must be at least {min} characters.",id:"6JNvt/A47+"},{min:e})}if("maxLength"in t){let e=t.maxLength;if(a.length>e)return n.formatMessage({defaultMessage:"Must be at most {max} characters.",id:"oVARYXBJid"},{max:e})}if("pattern"in t&&!new RegExp(t.pattern).test(a))return n.formatMessage({defaultMessage:"Invalid format.",id:"vChcf7nVHS"});if("format"in t){let e=t.format;if("email"===e&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))return n.formatMessage({defaultMessage:"Invalid email address.",id:"cpZU48Uo5t"});if("uri"===e)try{new URL(a)}catch(e){return n.formatMessage({defaultMessage:"Invalid URL.",id:"ZtqJIdqRiK"})}if("date"===e&&isNaN(new Date(a).getTime()))return n.formatMessage({defaultMessage:"Invalid date.",id:"bnRxzOhnEE"});if("date-time"===e&&isNaN(new Date(a).getTime()))return n.formatMessage({defaultMessage:"Invalid date and time.",id:"HTTZjKGN9a"})}}if("number"===t.type||"integer"===t.type){let a=Number(e);if(isNaN(a))return n.formatMessage({defaultMessage:"Must be a valid number.",id:"Z8e10tpxeL"});if("integer"===t.type&&!Number.isInteger(a))return n.formatMessage({defaultMessage:"Must be a whole number.",id:"5kFFmX4YGx"});if("minimum"in t){let e=t.minimum;if(a<e)return n.formatMessage({defaultMessage:"Must be at least {min}.",id:"85q0hz8G+z"},{min:e})}if("maximum"in t){let e=t.maximum;if(a>e)return n.formatMessage({defaultMessage:"Must be at most {max}.",id:"HrCLJ+XSxg"},{max:e})}}return null}function A(){let e=(0,h.A)(),t=(0,b.c)(e=>e.currentRequest),{acceptElicitation:a,declineElicitation:r,cancelElicitation:i}=(0,b.c)(),[s,l]=(0,g.useState)(new Set),o=(0,g.useMemo)(()=>{if(!t)return{};let e={};return Object.entries(t.request.params.requestedSchema.properties).forEach(t=>{let[a,n]=t;"default"in n&&void 0!==n.default&&(e[a]=n.default)}),e},[t]),u=(0,g.useCallback)(n=>{if(n.preventDefault(),!t)return;let r=n.currentTarget,i=new FormData(r),s={},o=new Set,u=t.request.params.requestedSchema;if(Object.entries(u.properties).forEach(t=>{var a,n;let[r,l]=t,d=i.get(r),c=d;"number"===l.type||"integer"===l.type?c=""===d||null===d?void 0:Number(d):"boolean"===l.type&&(c="true"===d),s[r]=c,R(c,l,null!=(n=null==(a=u.required)?void 0:a.includes(r))&&n,e)&&o.add(r)}),o.size>0){l(o);let e=Array.from(o)[0],t=r.querySelector('[name="'.concat(e,'"]'));null==t||t.scrollIntoView({behavior:"smooth",block:"center"});return}a(s),l(new Set)},[t,a,e]),d=(0,g.useCallback)(()=>{r(),l(new Set)},[r]),c=(0,g.useCallback)(()=>{i(),l(new Set)},[i]),m=(0,g.useCallback)(e=>()=>{l(t=>{let a=new Set(t);return a.delete(e),a})},[]);if(!t)return null;let{request:f,serverName:p,iconType:v,iconSrc:C}=t,w=f.params.requestedSchema,k=(0,n.jsx)(S.z,{size:30,imageSize:20,name:p,type:v,src:C});return(0,n.jsx)(_.aF,{title:"".concat(p," requests your input"),icon:k,isOpen:null!==t,onClose:c,modalSize:"lg",children:(0,n.jsxs)("form",{onSubmit:u,children:[(0,n.jsx)("div",{className:"py-4",children:(0,n.jsxs)("div",{className:"flex flex-col gap-4 max-h-[500px] overflow-y-auto p-2",children:[f.params.message&&(0,n.jsx)("p",{className:"text-sm text-text-300",children:f.params.message}),Object.entries(w.properties).map(e=>{var t,a;let[r,i]=e;return(0,n.jsx)(N,{fieldName:r,fieldSchema:i,isRequired:null!=(a=null==(t=w.required)?void 0:t.includes(r))&&a,initialValue:o[r],hasSubmitError:s.has(r),clearSubmitError:m},r)})]})}),(0,n.jsxs)(_.vW,{children:[(0,n.jsx)(x.$,{type:"button",onClick:d,variant:"secondary",children:(0,n.jsx)(y.A,{defaultMessage:"Decline",id:"pvtgR26QWY"})}),(0,n.jsx)(x.$,{type:"submit",variant:"primary",children:(0,n.jsx)(y.A,{defaultMessage:"Submit",id:"wSZR47Y5kj"})})]})]})})}var I=a(0x62983db6),T=a(0x2504fdeeb),D=a(0x17e7bc007),L=a(0x12bfc937),O=a(0x20885504e),U=a(0x1dbbefd33),z=a(0x116bf7f07),P=a(0x12c9046cd),F=a(0x14de19ae8),q=a(0x139b5e710),B=a(0x1016c6ed2),Q=a(0xe670e093),V=a(0x17e725145);function Y(e){var t,a,i,s;let{conversation:l,conversationUuid:x,chatInputDefaultMessage:_}=e,h=(0,p.useRouter)(),{incognitoModeEnabled:y}=(0,v.S)(),{track:b}=(0,c.st)(),{data:S,isLoading:C,isRefetching:w,isPlaceholderData:k}=(0,r.Bq)(x,{suppressError:!0}),M=(0,g.useMemo)(()=>{if((null==S?void 0:S.danglingHumanMessages)&&S.danglingHumanMessages.length>0)return S.danglingHumanMessages[S.danglingHumanMessages.length-1]},[S]),j=null==S?void 0:S.project_uuid,E=(0,D.gq)(),N=(0,D.xw)(x),{changeDisplayedConversationPath:R}=(0,d.G)(),Y=(0,u.Z3)(x),K=(0,z.n)(null!=(a=null==l?void 0:l.settings)?a:null==S?void 0:S.settings,null==l?void 0:l.project_uuid),{markFirstTokenReceived:G}=(0,T.B)(),H=(0,g.useCallback)(()=>{G({model:Y,integrations:function(e){if(!e)return"";let t=[];return Object.entries(e).forEach(e=>{var a,n;let[r,i]=e,s="enabled_mcp_tools"===r&&!("object"!=typeof i||null===i||Array.isArray(i))&&Object.values(i).every(e=>"boolean"==typeof e),l="paprika_mode"===r&&"string"==typeof(a=i)&&"extended"===a,o="compass_mode"===r&&"string"==typeof(n=i)&&"advanced"===n;s?Object.entries(i).forEach(e=>{let[a,n]=e;n&&t.push(a)}):l?t.push("enabled_paprika"):o?t.push("enabled_compass"):"boolean"==typeof i&&i&&t.push(r)}),t.join(",")}(null==S?void 0:S.settings)})},[G,Y,null==S?void 0:S.settings]);(0,g.useEffect)(()=>{if(!y||!(null==S?void 0:S.updated_at))return;let e=()=>{let e=new Date(S.updated_at).getTime();(Date.now()-e)/36e5>=47&&h.push("/new")};return window.addEventListener("focus",e),()=>{window.removeEventListener("focus",e)}},[y,null==S?void 0:S.updated_at,h]);let[J,W]=(0,g.useState)(),Z=(0,g.useCallback)(e=>{W(e)},[W]),[X,$]=(0,g.useState)(0),ee=(0,g.useCallback)(e=>{$(e)},[]),et=(0,O.N)(),ea=(0,L.G)(x,j,K,H,E,ee,et?M:void 0),en=(0,L.S)(x,j,K,J,H,E,ee,et?M:void 0),{mutate:er}=(0,r.lj)(x),ei=ea.isStreaming||en.isStreaming,es=ea.isReconnected||en.isReconnected,el=(0,g.useCallback)(async e=>($(0),ea.runStream(e)),[ea]),eo=(0,g.useCallback)(async(e,t,a,n)=>($(0),en.runStream(e,t,a,n)),[en]);(0,o.y)(S,null==S?void 0:S.chat_messages,ei);let eu=null==(t=(0,D.Q3)(x))?void 0:t.uuid,ed=(0,g.useCallback)(async(e,t)=>{var a,n;let r=(0,f.C)(e);r!==t&&(b({event_key:"claudeai.message.edited",is_last_human_message:e.uuid===eu,is_identical_content:r===t}),await el({prompt:t,attachments:e.attachments,files:null!=(n=e.files_v2)?n:e.files,syncSources:e.sync_sources,parent_message_uuid:e.parent_message_uuid,personalized_style:J,compass_mode:null==(a=e.metadata)?void 0:a.compass_mode}))},[el,J,b,eu]),ec=(0,g.useCallback)((e,t)=>{b({event_key:"claudeai.conversation_tree.navigated",direction:1===t?"next":"previous",is_last_human_message:e.uuid===eu}),R(x,e,t,e=>er({current_leaf_message_uuid:e}))},[R,x,er,b,eu]),{hasPendingUserMessage:em,isCompletionStatusLoading:ef,stopPendingRecovery:ep}=function(e){let{conversationUuid:t,pendingUserMessage:a,chatConversationTree:n,isLoading:i}=e,s=(0,g.useRef)(!1),l=(0,g.useRef)(null),o=(0,g.useRef)(null),d=(0,g.useRef)(null),c=(0,D.uQ)(),m=(0,D.Gu)(),f=(0,D.RR)(),{activeOrganization:p}=(0,F.YL)(),{addError:v}=(0,q.Y)(),{setFailedStreamRetryData:x}=(0,u.x)(),_=(0,V.useQueryClient)(),[h,y]=(0,g.useState)(!1),[b,S]=(0,g.useState)(!1),{data:C,isLoading:w}=(0,P.Sk)((null==p?void 0:p.uuid)&&t&&a?"/api/organizations/".concat(p.uuid,"/chat_conversations/").concat(t,"/completion_status?poll=false"):"",{enabled:!!(null==p?void 0:p.uuid)&&!!t&&!i&&!!a&&!s.current,staleTime:0,refetchOnWindowFocus:!1}),k=(0,g.useCallback)(()=>{var e;a&&x({prompt:(null!=(e=a.content)?e:[]).filter(e=>"text"===e.type).map(e=>e.text).join(""),attachments:a.attachments||[],files:a.files_v2||[]})},[a,x]),M=(0,g.useCallback)(()=>{o.current&&(o.current.abort(),o.current=null),d.current&&(clearTimeout(d.current),d.current=null)},[]),j=(0,g.useCallback)(()=>{let e=f(t),n=e.filter(e=>e.uuid!==(null==a?void 0:a.uuid)&&e.uuid!==l.current);n.length!==e.length&&m(t,n)},[t,f,null==a?void 0:a.uuid,m]),E=(0,g.useCallback)((e,t)=>{j(),k();let a=e||"Message failed. Please try again.";v(a,{error:new B.LG(a,t||"completion_error",500,{}),errorContext:{tags:{source:"pending_message_recovery"}}})},[j,k,v]),N=(0,g.useCallback)(()=>{if(!(null==p?void 0:p.uuid)||!t||!a)return;S(!0),o.current=new AbortController;let e=0,n=async()=>{var a,i,s;if(e>=10||(null==(a=o.current)?void 0:a.signal.aborted))return void S(!1);e++;try{let e=await fetch("/api/organizations/".concat(p.uuid,"/chat_conversations/").concat(t,"/completion_status?poll=true"),{method:"GET",credentials:"include",signal:null==(i=o.current)?void 0:i.signal});if(!e.ok)return void S(!1);let a=await e.json();a.is_pending?(null==(s=o.current)?void 0:s.signal.aborted)||(d.current=setTimeout(()=>void n(),2e3)):(y(!1),S(!1),j(),a.is_error&&E(a.error_detail,a.error_code),await (0,r.C4)(_,p.uuid,t))}catch(e){S(!1)}};n()},[null==p?void 0:p.uuid,t,a,_,E,j]);return(0,g.useEffect)(()=>{if(!i&&!s.current&&a&&n&&void 0!==C){if(s.current=!0,C.is_error)E(C.error_detail,C.error_code);else if(C.is_pending){y(!0);let e=(0,Q.b)();l.current=e;let n={uuid:e,sender:"assistant",content:[{type:"text",text:""}],created_at:new Date().toISOString(),updated_at:new Date().toISOString(),parent_message_uuid:a.uuid,attachments:[],files:[],files_v2:[],sync_sources:[],index:1,metadata:{is_resume_completion_placeholder_message:!0}};c(t,[a,n]),N()}}},[i,a,n,C,E,c,t,N]),(0,g.useEffect)(()=>()=>{M()},[M]),{hasPendingUserMessage:h,isCompletionStatusLoading:!!a&&w&&!b,stopPendingRecovery:()=>S(!1)}}({conversationUuid:x,chatConversationTree:S,pendingUserMessage:et?void 0:M,isLoading:C});S||C||k||(0,p.notFound)();let eg=(0,g.useMemo)(()=>{var e,t;return null!=(t=null!=(e=null==l?void 0:l.settings)?e:null==S?void 0:S.settings)?t:{}},[null==l?void 0:l.settings,null==S?void 0:S.settings]);return(0,n.jsxs)(m.N,{settings:eg,children:[(0,n.jsx)(U.v,{isStreaming:ei||em,isTemporary:!!(null==l?void 0:l.is_temporary),chatInputDefaultMessage:_,conversationTitle:l?"".concat(l.name," - Claude"):"Claude",conversationUuid:x,isLoading:C||!S&&w||ef,messageUuids:N,name:null!=(s=null!=(i=null==S?void 0:S.name)?i:null==l?void 0:l.name)?s:"Untitled Chat",onSend:el,onRetry:eo,projectUuid:j,changeDisplayedConversationPath:ec,editMessage:ed,setPersonalizedStyleCallback:Z,retryCount:X,onStopSampling:em?ep:void 0,isReconnected:es}),(0,I.F)()&&(0,n.jsx)(A,{})]})}var K=a(0x1df3358a6),G=a(0x90b81730);function H(e){var t;let{uuid:a,q:o}=e,{data:u,currentPath:d,isLoading:c}=(0,r.Bq)(a);return(0,i.K7)(null!=(t=null==u?void 0:u.name)?t:""),(0,G.V)(a,d||[],c),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(l.u,{conversationUuid:a,children:(0,n.jsx)(s._,{conversationUuid:a,children:(0,n.jsx)(Y,{conversation:u,conversationUuid:a,chatInputDefaultMessage:o})})}),(0,n.jsx)(K.PaymentVerificationModal,{})]})}},0x20885504e:(e,t,a)=>{a.d(t,{N:()=>l});var n=a(0x14de19ae8),r=a(0x22062498b),i=a(0xac309a83),s=a(0xfc89b4a4);function l(){let{account:e}=(0,n.YL)(),t=(0,i.fS)("claudeai_use_cached_stream");return(0,s.useMemo)(()=>{if(!(0,r.B)(e))return t;let a=new URLSearchParams(window.location.search).get("cached_stream");if(null!==a){if("true"===a||"1"===a)return!0;if("false"===a||"0"===a)return!1}return t},[e,t])}},0x22062498b:(e,t,a)=>{a.d(t,{B:()=>n});let n=e=>{var t;return!!(null==e||null==(t=e.email_address)?void 0:t.endsWith("@anthropic.com"))}},0x2349cee20:(e,t,a)=>{a.d(t,{G:()=>d});var n=a(0x628a9a0b),r=a(0x14de19ae8),i=a(0x49fac030),s=a(0x17e725145),l=a(0xfc89b4a4),o=a(0x20805e624),u=a(0x10e9ea2cc);let d=(e,t)=>{let a=(0,s.useQueryClient)(),{activeOrganization:d}=(0,r.YL)(),c=null==d?void 0:d.uuid,m=(0,n.oF)(),f=(0,l.useRef)(void 0),p=(0,u.$)(),g=(0,l.useCallback)(async(e,t)=>{let n=[i.fC,{orgUuid:c},{uuid:e}],r=a.getQueryData(n);if(!r)throw Error("Conversation tree must be provided for append");f.current=t(r),await a.cancelQueries({queryKey:n}),a.setQueryData(n,f.current)},[a,c]),v=(0,l.useRef)(new Set),x=(0,l.useCallback)((n,r)=>{if(0!==r.length){if(e&&!v.current.has(n)&&r.some(e=>"text"===e.type&&e.text&&e.text.trim().length>0)&&(v.current.add(n),e()),t){var s,l;t(null!=(l=null==(s=f.current)?void 0:s.uuid)?l:"",n,r);return}a.setQueryData([i.fC,{orgUuid:c},{uuid:n}],()=>{let e=f.current;if(!e)throw Error("Conversation tree must be provided for incremental completion");if(!e.current_leaf_message_uuid)throw Error("Couldn't figure out where to put completion");let t=e.messageByUuid.get(e.current_leaf_message_uuid);if(!t)throw Error("New assistant message not found");return t.content=r,{...e,created_at:new Date().toISOString()}})}},[a,c,e,t]);return{onStartAppend:g,onStreamCompleted:(0,l.useCallback)((e,t,r,s)=>{(null==s?void 0:s.shouldRefetch)!==!1&&(m(e,c,r),a.invalidateQueries({queryKey:["FEATURE_LIMITS",c]}));let l=f.current,o=(null==l?void 0:l.chat_messages)&&l.chat_messages.length<=2;!l||!o||l.is_temporary||(null==s?void 0:s.skipOptimisticUpdate)||(a.setQueriesData({queryKey:[i.DC,{orgUuid:c}],predicate:e=>{let{queryKey:t}=e,a=t[2];return!(null==a?void 0:a.starred)}},t=>!t||t.some(t=>t.uuid===e)?t:[{uuid:e,name:l.name,summary:l.summary,updated_at:l.updated_at,created_at:l.created_at,project_uuid:l.project_uuid,model:l.model,settings:l.settings,is_starred:!1},...t].slice(0,n.sk)),a.setQueryData([i.Ad,{orgUuid:c}],e=>{var t;return{is_first_conversation:!1,count:(null!=(t=null==e?void 0:e.count)?t:0)+1}})),t&&c&&p(t,c,e)},[a,p,c,m]),onIncrementalCompletion:x,changeDisplayedConversationPath:(0,l.useCallback)((e,t,n,r)=>{a.setQueryData([i.fC,{orgUuid:c},{uuid:e}],e=>{if(!e)throw Error("Conversation tree must be provided for changeDisplayedConversationPath");let a=(0,o.gX)(e,t,n);return a.current_leaf_message_uuid&&r&&r(a.current_leaf_message_uuid),a})},[a,c])}}}}]);